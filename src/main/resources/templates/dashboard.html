<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Sensors Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
    <script src="https://code.highcharts.com/modules/data.js"></script>
    <script src="https://code.highcharts.com/modules/series-label.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <style>
        .highcharts-figure,
        .highcharts-data-table table {
            min-width: 360px;
            max-width: 800px;
            margin: 1em auto;
        }

        .highcharts-data-table table {
            font-family: Verdana, sans-serif;
            border-collapse: collapse;
            border: 1px solid #ebebeb;
            margin: 10px auto;
            text-align: center;
            width: 100%;
            max-width: 500px;
        }

        .highcharts-data-table caption {
            padding: 1em 0;
            font-size: 1.2em;
            color: #555;
        }

        .highcharts-data-table th {
            font-weight: 600;
            padding: 0.5em;
        }

        .highcharts-data-table td,
        .highcharts-data-table th,
        .highcharts-data-table caption {
            padding: 0.5em;
        }

        .highcharts-data-table thead tr,
        .highcharts-data-table tr:nth-child(even) {
            background: #f8f8f8;
        }

        .highcharts-data-table tr:hover {
            background: #f1f7ff;
        }
        .data-area {
            height: 30%;
        }
    </style>

    <script>
        function update() {
            const form = document.getElementById('form');
            form.submit();
        }

        function scrollDown() {
            let sensorMessages = document.getElementById('sensorMessages');
            sensorMessages.scrollTop = sensorMessages.scrollHeight;
            let sensorData = document.getElementById('sensorData');
            sensorData.scrollTop = sensorData.scrollHeight;
        }

        $(document).ready(function () {
            setInterval(function () {
                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);
                console.log(queryString)

                if (urlParams.has('id')) {
                    update();
                }
            }, 3000);
        })
    </script>
</head>
<body onload="scrollDown()">
<div class="container px-4">

    <h2 class="title lead">
        Sensors Dashboard
    </h2>

    <button th:if="${id == null}" type="button" class="btn btn-primary mb-4" data-bs-toggle="modal"
            data-bs-target="#createSensor">
        Add sensor
    </button>

    <form method="get" th:action="@{/dashboard}">
        <button th:if="${id != null}" type="submit" class="btn btn-primary mb-4">
            Go back
        </button>
    </form>

    <form method="get" id="formc" th:action="@{/dashboard/{id}/chart/(id = ${id})}">
        <button th:if="${id != null}" type="submit" class="btn btn-light mb-4 float-right">
            Go to chart>
        </button>
    </form>

    <form method="get" id="form" th:action="@{/dashboard/{id}(id = ${id})}"
          th:object="${selectedSensor}">
        <select name="id" id="id" onchange="update()" th:hidden="${id!=null}">
            <option th:text="'Select sensor ->'" th:value="${null}" selected></option>
            <option th:each="s: ${sensorList}" th:value="${s.id}" th:text="${s.name}"></option>
        </select>
    </form>
    <div th:if="${sensor} != null and ${chart} == true">
        <h5 class="lead" th:text="'sensor name:' + ${sensor.name}"></h5>
        <h6 class="lead" th:text="'sensor details:' + ${sensor.sensorInfo}"></h6>

        <figure class="highcharts-figure">
            <div id="container"></div>
            <script>
                Highcharts.addEvent(Highcharts.Point, 'click', function () {
                    if (this.series.options.className.indexOf('popup-on-click') !== -1) {
                        const chart = this.series.chart;
                        const date = Highcharts.dateFormat('%A, %b %e, %Y', this.x);
                        const text = `<b>${date}</b><br/>${this.y} ${this.series.name}`;

                        const anchorX = this.plotX + this.series.xAxis.pos;
                        const anchorY = this.plotY + this.series.yAxis.pos;
                        const align = anchorX < chart.chartWidth - 200 ? 'left' : 'right';
                        const x = align === 'left' ? anchorX + 10 : anchorX - 10;
                        const y = anchorY - 30;
                        if (!chart.sticky) {
                            chart.sticky = chart.renderer
                                .label(text, x, y, 'callout',  anchorX, anchorY)
                                .attr({
                                    align,
                                    fill: 'rgba(0, 0, 0, 0.75)',
                                    padding: 10,
                                    zIndex: 7 // Above series, below tooltip
                                })
                                .css({
                                    color: 'white'
                                })
                                .on('click', function () {
                                    chart.sticky = chart.sticky.destroy();
                                })
                                .add();
                        } else {
                            chart.sticky
                                .attr({ align, text })
                                .animate({ anchorX, anchorY, x, y }, { duration: 250 });
                        }
                    }
                });

                Highcharts.chart('container', {

                    chart: {
                        scrollablePlotArea: {
                            minWidth: 700
                        }
                    },

                    data: {
                        csvURL: 'http://167.71.41.15:8080/dashboard/1d4cb3df-2ba4-42a3-8828-2ee91c731558/chart-data',
                        beforeParse: function (csv) {
                            return csv.replace(/\n\n/g, '\n');
                        }
                    },

                    title: {
                        text: 'Real-time data'
                    },

                    xAxis: {
                        tickInterval: 7 * 24 * 3600 * 1000, // one week
                        tickWidth: 0,
                        gridLineWidth: 1,
                        labels: {
                            align: 'left',
                            x: 3,
                            y: -3
                        }
                    },

                    yAxis: [{ // left y axis
                        title: {
                            text: null
                        },
                        labels: {
                            align: 'left',
                            x: 3,
                            y: 16,
                            format: '{value:.,0f}'
                        },
                        showFirstLabel: false
                    }, { // right y axis
                        linkedTo: 0,
                        gridLineWidth: 0,
                        opposite: true,
                        title: {
                            text: null
                        },
                        labels: {
                            align: 'right',
                            x: -3,
                            y: 16,
                            format: '{value:.,0f}'
                        },
                        showFirstLabel: false
                    }],

                    legend: {
                        align: 'left',
                        verticalAlign: 'top',
                        borderWidth: 0
                    },

                    tooltip: {
                        shared: true,
                        crosshairs: true
                    },

                    plotOptions: {
                        series: {
                            cursor: 'pointer',
                            className: 'popup-on-click',
                            marker: {
                                lineWidth: 1
                            }
                        }
                    },

                    series: [{
                        name: 'Data',
                        lineWidth: 4,
                        marker: {
                            radius: 4
                        }
                    }]
                });
            </script>
            <p class="highcharts-description">
                Chart showing data loaded dynamically. The individual data points can
                be clicked to display more information.
            </p>
        </figure>
    </div>

    <div th:if="${sensor} != null and ${chart} == false">
        <h5 class="lead" th:text="${sensor.name}"></h5>
        <h6 class="lead" th:text="${sensor.sensorInfo}"></h6>

        <div class="row gx-5">
            <div class="col data-area">
                <div class="p-3 border bg-light">
                    <label for="sensorData" class="form-label">Sensor Data</label>
                    <textarea class="form-control" id="sensorData" rows="15"
                              th:text="${sensor.getSensorDataString()}"></textarea>
                </div>
            </div>
            <div class="col data-area">
                <div class="p-3 border bg-light">
                    <label for="sensorMessages" class="form-label">Sensor Messages</label>
                    <textarea class="form-control" id="sensorMessages" rows="15"
                              th:text="${sensor.getSensorMessagesString()}"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="createSensor" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true"
         th:if="${chart == false}">
        <div class="modal-dialog">
            <div class="modal-content">
                <form th:action="@{/dashboard}" method="post" th:object="${sensorRequest}">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">Add Sensor</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <input th:field="*{name}" name="name" id="name" class="form-control mb-4"
                                   placeholder='Sensor name'/>
                            <input th:field="*{sensorInfo}" name="sensorInfo" id="sensorInfo"
                                   class="form-control mb-4"
                                   placeholder='Sensor description'/>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</body>
</html>